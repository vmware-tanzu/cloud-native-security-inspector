# Project Narrows Architecture Refactoring
## Abstract
This doc will cover the current design and redesign of Project Narrows to improve readability and maintainability of 
source code as well as the overall structure and functionality. Hopefully, it makes code easier to expand upon and 
add new features.

## Background
Today, Project Narrows consists of the following 3 internal components and a external datastore.
### Internal components:
#### 1.[Controller Manager](https://github.com/vmware-tanzu/cloud-native-security-inspector/tree/main/src/controllers):
It reconciles the CR of CNSI and runs as the Deployment in Kubernetes.
#### 2.[Portal](https://github.com/vmware-tanzu/cloud-native-security-inspector/tree/main/src/frontend):
It is written by AngularJS and followed [Clarity](https://clarity.design/) style.  The portal talks to Kubernetes API server and
#### 3.[Scanners](https://github.com/vmware-tanzu/cloud-native-security-inspector/tree/main/src/pkg/inspection):
Currently there are 4 kinds of scanners running as CronJob resource in Kubernetes.  
Scanners are triggered periodically and scheduled to different Kubernetes nodes.
### External datastore:
#### OpenSearch or ElasticSearch
A OpenSearch or ElasticSearch instance can be set in policy of Project Narrows. The reports generated by the scanning job can
be exported to the external datastore instance. At the same time, the portal can fetch the data in datastore and show it in portal.
Currently, only OpenSearch and ElasticSearch are supported in Project Narrows.

## Glossary

## Goals
* To define common operations, provide a default implementation, and provide the ability to swap out implementations for alternative ones.
* To work in different environments, both on-premises and in the cloud.
* To reuse and integrate existing ecosystem components rather than duplicating their functionality (e.g. Falco, Kube-bench, Harbor).

## Non-goals
* Define a new set of security guidelines or best practices.
* Implement the whole security stack

## High-Level Design
![Narrows for single cluster](https://github.com/4everming/cloud-native-security-inspector/blob/doc/commit-the-design-doc-for-new-architecture-of-Narrows/docs/pictures/architecture-refactor-1.png)

![Narrows for multi-cluster](https://github.com/4everming/cloud-native-security-inspector/blob/doc/commit-the-design-doc-for-new-architecture-of-Narrows/docs/pictures/architecture-refactor-multi-cluster.png)

## Detailed Design
There are several components as the picture showing above which can be divided into 3 categories:   
### 1. Components on the control plane node:
* **Manager(Portal):**  
A component that allows user to set up the configurations and security policies of Project Narrows, and acquire the scanning reports
* **Resource Collector:**  
Talk to Kubernetes API server to collect the Kubernetes workloads related info. In addition to that, 
it also talks to external image registries such as Harbor and DevOps platform such as GitLab to collect the security data.
* **Database:**  
It is a relational database to store the data collected from **Resource Collector** and **Data Collector**
* **Scanner**  
It is a component to scan the resource based on the data which has already been gathered to databases according to 
the polices defined by user. After that it will generate the scanning reports. It can be triggered manually or periodically.
* **Data Exporter**  
It is a component to export the scanning reports generated by **Scanner** to other places outside Project Narrows so that
other system can consume the data easily and make capabilities of Project Narrows can be integrated by others.
* **Rule Engine Connector**  
It is a component to connect to the policy engine such as OPA(Open Policy Agent).
### 2. Components on each worker node:
* **Data Collector**  
Data Collector will collect all the security related data from Kubernetes worker node and sync the data to database on 
control plane node, including the security data of worker node and containers on this worker node. 
* **Action Enforcer**  
It will receive the action items from components on control plane node.
### 3. External components:
* **Image registries**  
It is the place to manage the image artifacts and scan the images to produce security data as well.
* **DevOps platforms**  
It is the place to track the source code and generate the scanning reports based on the code.
## Test Plan
E2E tests and unit tests should be included.
## References
