# Project Narrows Architecture Refactoring
## Abstract
This doc will cover the current design and redesign of Project Narrows to improve readability and maintainability of 
source code as well as the overall structure and functionality. Hopefully, it makes code easier to expand upon and 
add new features.

## Background
Today, Project Narrows consists of the following 3 internal components and a external datastore.
### Internal components:
#### 1.[Controller Manager](https://github.com/vmware-tanzu/cloud-native-security-inspector/tree/main/src/controllers):
It reconciles the CR of CNSI and runs as the Deployment in Kubernetes.
#### 2.[Portal](https://github.com/vmware-tanzu/cloud-native-security-inspector/tree/main/src/frontend):
It is written by AngularJS and followed [Clarity](https://clarity.design/) style.  The portal talks to Kubernetes API 
server and fetches data from OpenSearch.
#### 3.[Scanners](https://github.com/vmware-tanzu/cloud-native-security-inspector/tree/main/src/pkg/inspection):
Currently there are 3 kinds of scanners(image scanner, kube-bench scanner and risk scanner) running as CronJob resource in Kubernetes.  
Scanners are triggered periodically and scheduled to different Kubernetes nodes.
### External datastore:
#### OpenSearch or ElasticSearch
A OpenSearch or ElasticSearch instance can be set in policy of Project Narrows. The reports generated by the scanning job can
be exported to the external datastore instance. At the same time, the portal can fetch the data in datastore and show it in portal.
Currently, only OpenSearch and ElasticSearch are supported in Project Narrows.

## Glossary
* Management cluster:  
A Kubernetes cluster that manages the lifecycle of Workload Clusters. A Management Cluster is also where one or more 
providers run, and where resources such as Machines are stored.
* Workload cluster:  
A Kubernetes cluster whose lifecycle is managed by a Management Cluster.

## Goals
* To define common operations, provide a default implementation, and provide the ability to swap out implementations for alternative ones.
* To work in different environments, both on-premises and in the cloud.
* To reuse and integrate existing ecosystem components rather than duplicating their functionality (e.g. Falco, Kube-bench, Harbor).

## Non-goals
* Define a new set of security guidelines or best practices.
* Implement the whole security stack

## High-Level Design
![Narrows for single cluster](https://github.com/4everming/cloud-native-security-inspector/blob/doc/commit-the-design-doc-for-new-architecture-of-Narrows/docs/pictures/architecture-refactor-1.png)
<div style="text-align: center;">single cluster</div>

![Narrows for multi-cluster](https://github.com/4everming/cloud-native-security-inspector/blob/doc/commit-the-design-doc-for-new-architecture-of-Narrows/docs/pictures/architecture-refactor-multi-cluster.png)
<div style="text-align: center;">multi-cluster</div>

## Detailed Design
There are several components as the picture showing above which can be divided into 3 categories:   
### 1. Components on the control plane node:
* **Manager(Portal):**  
A component that allows user to set up the configurations and security policies of Project Narrows, and acquire the scanning reports
* **Resource Collector:**  
Talk to Kubernetes API server to collect the Kubernetes workloads related info. In addition to that, 
it also talks to external image registries such as Harbor and DevOps platform such as GitLab to collect the security data.
* **Database:**  
It is a relational database to store the data collected from **Resource Collector** and **Data Collector**
* **Scanner**  
It is a component to scan the resource based on the data which has already been gathered to databases according to 
the polices defined by user. After that it will generate the scanning reports. It can be triggered manually or periodically.
* **Data Exporter**  
It is a component to export the scanning reports generated by **Scanner** to other places outside Project Narrows so that
other system can consume the data easily and make capabilities of Project Narrows can be leveraged by others.
* **Rule Engine Connector**  
It is a component to connect to the policy engine such as OPA(Open Policy Agent).
### 2. Components on each worker node:
* **Data Collector**  
Data Collector will collect all the security related data from Kubernetes worker node and sync the data to database on 
control plane node, including the security data of worker node and containers on this worker node. 
* **Action Enforcer**  
It will receive the action items from components on control plane node.
### 3. External components:
* **Image registries**  
It is the place to manage the image artifacts and scan the images to produce security data as well.
* **DevOps platforms**  
It is the place to track the source code and generate the scanning reports based on the code.
## Roadmap
### Phase 0
This will introduce a new runtime security tool "Falco" to Project Narrows with the refactored architecture. In order to make it
easy and quick for the first deliverables, we will only implement the necessary parts and keep other parts of the 
project the same as before. So you should expect the Cronjob resource created by Narrows are still existing in Kubernetes
and some Daemonsets are introduced.

### Phase 1
In this phase, we plan to remove all the Cronjob resources created by Project Narrows and move all the functionalities to
the agent in Daemonsets. After that, we should have a clear and flexible architecture on the node agent side to adapt 
new node/container security components, and make the scanning jobs decoupled with Kubernetes scheduler as well.

### Phase 2
This will implement the rule engine connector and data exporter parts to make it easy to be integrated with other solutions.

### Phase 3
In this phase, we plan to investigate the possibilities to integrate with DevOps platform such as GitLab etc.

### Phase 4
In this phase, we will try to expand the Narrows capabilities to multi-cluster, so that users will have a central place
to know clearly about the security trends of all their clusters.
## Test Plan
Unit tests and E2E tests should be included and integrated to CI system.   
Unit tests cover individual functions within the project. These tests 
should be independent and fast, and should cover all the possible paths in the tested function, including negative and
failure cases.  It should mock all other objects other than the one that is currently being tested, and should test that
the appropriate fields are passed as output or as function calls to other parts of the code base.  
E2E tests should cover the users' basic flow of Project Narrows and "sigs.k8s.io/e2e-framework" is introduced to set up
env for E2E tests.
## References
[Open Policy Agent](https://www.openpolicyagent.org/docs/latest/)  
[Kyverno](https://kyverno.io/)  
[Cluster API](https://cluster-api.sigs.k8s.io/introduction.html)  

